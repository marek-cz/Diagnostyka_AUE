/*
 * slownik.c
 *
 * Created: 2020-05-12 12:42:16
 *  Author: Marek
 */ 
//	BIBLIOTEKI
#include "slownik.h"
#include <math.h>
//###################################################

const char PROGMEM NOM_STR[] = "NOM";
#ifdef HPF
//				NAPISY
const char PROGMEM C1_P[] = "C1+";
const char PROGMEM C1_M[] = "C1-";
const char PROGMEM C2_P[] = "C2+";
const char PROGMEM C2_M[] = "C2-";
const char PROGMEM C3_P[] = "C3+";
const char PROGMEM C3_M[] = "C3-";
const char PROGMEM R1_P[] = "R1+";
const char PROGMEM R1_M[] = "R1-";
const char PROGMEM R2_P[] = "R2+";
const char PROGMEM R2_M[] = "R2-";
const char * const NapisyLCD[LICZBA_USZKODZEN+1] PROGMEM = {C1_P, C1_M, C2_P, C2_M, C3_P, C3_M, R1_P, R1_M, R2_P, R2_M, NOM_STR };
//############################################################
//				PARAMETRY MULTISIN:
const uint16_t PROGMEM czestotliwosci_multisin_k[LICZBA_PROBEK_WIDMA]={1,2,3,4,5,6,7,8,9,10}; // probki widma DTF
const float  srodek_multisin[WYMIAR_PO_PCA] = { -0.12323229164285888 , -0.015245077806682791 }; 
const float  graniczna_odleglosc_Mah_multisin =  0.006462980852129016;
const float  sigma_multisin[WYMIAR_PO_PCA][WYMIAR_PO_PCA] =  { { 1.02555105677709 , 0.33865516247424965} , {0.33865516247424965 , 5.4885548206872325} }; 
const float PROGMEM slownik_uszkodzen_multisin[LICZBA_USZKODZEN][LICZBA_PUNKTOW][WYMIAR_PO_PCA]=
{

	{ // C1+
		{ -0.128046007365739 , -0.015511083204792 },
		{ -0.136468727188786 , -0.01590315048756 },
		{ -0.144578164690901 , -0.01621712498928 },
		{ -0.152389460904128 , -0.016462232834441 },
		{ -0.15991684408609 , -0.01664664815138 },
		{ -0.167173701265546 , -0.016777618671399 },
	},
	{ // C1-
		{ -0.068730526077614 , -0.010690627624268 },
		{ -0.079462805761782 , -0.011845024895964 },
		{ -0.089763770665459 , -0.012831636263012 },
		{ -0.099656372250639 , -0.013670262915578 },
		{ -0.109161939368898 , -0.014378318345489 },
		{ -0.11830033997915 , -0.014971140698127 },
	},
	{ // C2+
		{ -0.118524574569488 , -0.016772927120408 },
		{ -0.110693392937147 , -0.018923939598559 },
		{ -0.103621170846343 , -0.020450870562975 },
		{ -0.097237903400835 , -0.021480313239437 },
		{ -0.091471929117138 , -0.022118726334329 },
		{ -0.086255095040964 , -0.022453234173208 },
	},
	{ // C2-
		{ -0.180522094080605 , 0.016537866229568 },
		{ -0.170182010337232 , 0.008791112590617 },
		{ -0.159095123852397 , 0.001633925884378 },
		{ -0.14813807953753 , -0.004508335287045 },
		{ -0.137768389029925 , -0.009525450517599 },
		{ -0.128185458690339 , -0.013475426950696 },
	},
	{ // C3+
		{ -0.124450803297962 , -0.017611573476428 },
		{ -0.126190467948348 , -0.021573291142357 },
		{ -0.127454040141002 , -0.025154570792459 },
		{ -0.128354032489102 , -0.028354013476057 },
		{ -0.128975420055165 , -0.031187404131403 },
		{ -0.129382642561446 , -0.033679851259812 },
	},
	{ // C3-
		{ -0.090261047040302 , 0.008268933114784 },
		{ -0.100407386098967 , 0.005186756428464 },
		{ -0.10818468421963 , 0.001111069601377 },
		{ -0.114066321243898 , -0.003471418171025 },
		{ -0.118480814565736 , -0.008191887445136 },
		{ -0.121776185755822 , -0.012801655603161 },
	},
	{ // R1+
		{ -0.125701196026216 , -0.018165470717221 },
		{ -0.129494491403497 , -0.023388848053862 },
		{ -0.132562651847486 , -0.028486881796888 },
		{ -0.135033794846824 , -0.033367685537113 },
		{ -0.137014252331596 , -0.03797124303204 },
		{ -0.138591608241663 , -0.042262301923812 },
	},
	{ // R1-
		{ -0.076824807401158 , 0.005801900878594 },
		{ -0.088684162237294 , 0.004037434976779 },
		{ -0.098886681009329 , 0.001100326387187 },
		{ -0.107473615208983 , -0.002791056736247 },
		{ -0.114596835582177 , -0.007369555459524 },
		{ -0.120449958404668 , -0.012375007447957 },
	},
	{ // R2+
		{ -0.122016109562684 , -0.016566201158318 },
		{ -0.12001737271611 , -0.01844576505443 },
		{ -0.11822801817967 , -0.019844048564175 },
		{ -0.116623966289638 , -0.020882305082111 },
		{ -0.115182384275002 , -0.021650005856382 },
		{ -0.113882764106026 , -0.022213371672468 },
	},
	{ // R2-
		{ -0.137211763736622 , 0.019137377872967 },
		{ -0.135348213961095 , 0.008896596760154 },
		{ -0.132612930063588 , 0.000730009218273 },
		{ -0.129743575550935 , -0.005514961284004 },
		{ -0.127012322872292 , -0.010208477742445 },
		{ -0.124509463387191 , -0.013711838499029 },
	}

};

const float PROGMEM fi_multisin[WYMIAR_PO_PCA][LICZBA_PROBEK_WIDMA] =
{
	{ -0.009995126223804496,-0.04146872984856673,-0.09817086191125346,-0.17965824030596514,-0.26826411379355886,-0.3499784748217347,-0.4102519863385079,-0.4402604660690796,-0.44820584131285224,-0.44585964877444917},
	{-0.026575385395010587,-0.12060651755415594,-0.3123457489734443,-0.5393435476528992,-0.5355567598040882,-0.27437813512125664,0.01474717844086465,0.20306595596025137,0.29257705581827215,0.32731863402530337}
};
//############################################################

//############################################################
//				PARAMETRY SINC'A
const uint16_t PROGMEM czestotliwosci_sinc[LICZBA_PROBEK_WIDMA]={50,60,70,80,90,100,110,120,130,140};
const float  srodek_sinc[WYMIAR_PO_PCA] = { -0.001366999906371269 , 0.000277643559496507 }; 
const float  graniczna_odleglosc_Mah_sinc = 6.727992874525447e-05;
const float  sigma_sinc[WYMIAR_PO_PCA][WYMIAR_PO_PCA] = { { 1.1261260667465336 , 0.791837383069004} , {0.791837383069004 , 5.971267695880962} }; 
const float PROGMEM slownik_uszkodzen_sinc[LICZBA_USZKODZEN][LICZBA_PUNKTOW][WYMIAR_PO_PCA]=
{

	{ // C1+
		{ -0.001416795351871 , 0.000288055755246 },
		{ -0.001501899278605 , 0.000305537823951 },
		{ -0.001583440950763 , 0.000322970120062 },
		{ -0.001660679099008 , 0.000338826866882 },
		{ -0.001735154447849 , 0.000354160302329 },
		{ -0.001806040372278 , 0.000368545711359 },
	},
	{ // C1-
		{ -0.00078795520317 , 0.000156977384068 },
		{ -0.000905403932261 , 0.00018117198097 },
		{ -0.001016445618282 , 0.000204418461315 },
		{ -0.001121678935611 , 0.000226082933317 },
		{ -0.001222023248559 , 0.000247052303834 },
		{ -0.001316747520314 , 0.000267020230241 },
	},
	{ // C2+
		{ -0.001340274265783 , 0.000251967838255 },
		{ -0.001290652205407 , 0.000211158332409 },
		{ -0.001240186985714 , 0.000175998054274 },
		{ -0.001191364498154 , 0.000146125882159 },
		{ -0.001143292715335 , 0.00012120573317 },
		{ -0.0010965654481 , 0.000100409436464 },
	},
	{ // C2-
		{ -0.001516426882663 , 0.000544306056469 },
		{ -0.001521206805731 , 0.000512550417834 },
		{ -0.001506531621209 , 0.000465983002108 },
		{ -0.001476872294915 , 0.000412200487601 },
		{ -0.001438843429271 , 0.000357376802714 },
		{ -0.001393207052176 , 0.000304873867891 },
	},
	{ // C3+
		{ -0.001407287991836 , 0.000264566220286 },
		{ -0.001471343513334 , 0.000240720494174 },
		{ -0.001525430003122 , 0.000216477609985 },
		{ -0.001572601141183 , 0.000192886164199 },
		{ -0.001612042721684 , 0.000170900090242 },
		{ -0.001644981603406 , 0.000150628311632 },
	},
	{ // C3-
		{ -0.00075831877881 , 0.000272169626252 },
		{ -0.000897512004744 , 0.000302404740452 },
		{ -0.001024441498644 , 0.000316868444998 },
		{ -0.001137492220282 , 0.000317411656088 },
		{ -0.001237598953089 , 0.000307013172751 },
		{ -0.001323627762304 , 0.000289720497418 },
	},
	{ // R1+
		{ -0.001425611389515 , 0.0002675118577 },
		{ -0.001524109662388 , 0.000245570512839 },
		{ -0.001613857544826 , 0.000219839063471 },
		{ -0.001694326213907 , 0.000192473432088 },
		{ -0.001766090746746 , 0.00016500994798 },
		{ -0.001830642561105 , 0.00013746727081 },
	},
	{ // R1-
		{ -0.000658202527945 , 0.000215214604789 },
		{ -0.000795673252839 , 0.000249986277671 },
		{ -0.00093243689204 , 0.000276140873859 },
		{ -0.001064370557625 , 0.00028995026143 },
		{ -0.001188697541737 , 0.000292907279371 },
		{ -0.001305981224859 , 0.000285185283676 },
	},
	{ // R2+
		{ -0.001370823096047 , 0.000259348906341 },
		{ -0.001374437649285 , 0.000230831294159 },
		{ -0.001373626932415 , 0.000207601660082 },
		{ -0.001370858978658 , 0.000187991715001 },
		{ -0.001365073220755 , 0.000172094046649 },
		{ -0.001358735486034 , 0.000158469293387 },
	},
	{ // R2-
		{ -0.001098456589699 , 0.000503194089003 },
		{ -0.001207385992615 , 0.000480185606682 },
		{ -0.001275743343119 , 0.00043563254572 },
		{ -0.001317355290303 , 0.000386226625457 },
		{ -0.001344723926372 , 0.00033916015498 },
		{ -0.001360807817965 , 0.000297844720867 },
	}

};

const float PROGMEM fi_sinc[WYMIAR_PO_PCA][LICZBA_PROBEK_WIDMA] =
{
	{ -0.12146499285024481,-0.18291887386021694,-0.2525036384281879,-0.3175969775027745,-0.36290676794289567,-0.38225229043032827,-0.38104754103096594,-0.3678266048016501,-0.34873388079065326,-0.3274659042774886},
	{-0.14616182730756086,-0.22520515193279833,-0.30433179946203803,-0.3458167956076488,-0.3087554923549103,-0.18286650176314706,0.006246410827624505,0.22035933296136034,0.4256151491810455,0.5976593005071319}
};
//############################################################

#endif


//###################################################

#ifdef BPF
//				NAPISY
const char PROGMEM C1_P[] = "C1+";
const char PROGMEM C1_M[] = "C1-";
const char PROGMEM C2_P[] = "C2+";
const char PROGMEM C2_M[] = "C2-";
const char PROGMEM R1_P[] = "R1+";
const char PROGMEM R1_M[] = "R1-";
const char PROGMEM R2_P[] = "R2+";
const char PROGMEM R2_M[] = "R2-";
const char PROGMEM R3_P[] = "R3+";
const char PROGMEM R3_M[] = "R3-";
const char * const NapisyLCD[LICZBA_USZKODZEN+1] PROGMEM = {C1_P, C1_M, C2_P, C2_M, R1_P, R1_M, R2_P, R2_M, R3_P, R3_M, NOM_STR };
//############################################################
//				PARAMETRY MULTISIN:
const uint16_t PROGMEM czestotliwosci_multisin_k[LICZBA_PROBEK_WIDMA]={1,2,3,4,5,6,7,8,9,10}; // probki widma DTF
const float  srodek_multisin[WYMIAR_PO_PCA] = { -0.09107076113936169 , -0.01981282667223835 };
const float  graniczna_odleglosc_Mah_multisin = 0.003677490239713203;
const float  sigma_multisin[WYMIAR_PO_PCA][WYMIAR_PO_PCA] = { { 1.0462434692709368 , 0.23789330167253842} , {0.23789330167253836 , 2.2238100616778187} };
const float PROGMEM slownik_uszkodzen_multisin[LICZBA_USZKODZEN][LICZBA_PUNKTOW][WYMIAR_PO_PCA]=
{

	{ // C1+
		{ -0.092035238611852 , -0.022028928617723 },
		{ -0.093494708777257 , -0.025755470732166 },
		{ -0.094655381840715 , -0.029163862545217 },
		{ -0.095578610330365 , -0.032262218748762 },
		{ -0.096312573431911 , -0.035068922942958 },
		{ -0.09689544075625 , -0.037607503209106 },
	},
	{ // C1-
		{ -0.069640349773566 , 0.004474120408201 },
		{ -0.075861479833527 , 0.000429330293732 },
		{ -0.080740507176306 , -0.004047149734155 },
		{ -0.084571233773232 , -0.008652760663158 },
		{ -0.087585936314712 , -0.013187801567191 },
		{ -0.089966068529413 , -0.017526602952971 },
	},
	{ // C2+
		{ -0.087652608201764 , -0.020979932016879 },
		{ -0.082012902436191 , -0.02259251818611 },
		{ -0.076955594992451 , -0.023710457353835 },
		{ -0.072408038129064 , -0.024441074809668 },
		{ -0.068306789668022 , -0.02487157655529 },
		{ -0.064596960504166 , -0.025071668806071 },
	},
	{ // C2-
		{ -0.139280699547132 , 0.008948240816401 },
		{ -0.12857877937886 , 0.000727678463953 },
		{ -0.118736039965156 , -0.005951690785522 },
		{ -0.109832771134068 , -0.011237351510595 },
		{ -0.101844111993851 , -0.015334652985106 },
		{ -0.094701124767803 , -0.018449055739969 },
	},
	{ // R1+
		{ -0.086560338177399 , -0.019623871753049 },
		{ -0.079461619889767 , -0.019146966204025 },
		{ -0.073421702471165 , -0.018583067119268 },
		{ -0.068222865148116 , -0.017980284870215 },
		{ -0.063702709655413 , -0.017367424579146 },
		{ -0.059737765391715 , -0.016761619461944 },
	},
	{ // R1-
		{ -0.185619686927025 , -0.007265739062693 },
		{ -0.157040588397646 , -0.014174749477194 },
		{ -0.135793028666973 , -0.017656118498817 },
		{ -0.119447597433862 , -0.01929442484406 },
		{ -0.106518930299707 , -0.019911001762503 },
		{ -0.09605621887995 , -0.019951979782285 },
	},
	{ // R2+
		{ -0.090888355086269 , -0.020605065340701 },
		{ -0.090586246674334 , -0.021827541472589 },
		{ -0.090308694039533 , -0.0228571725567 },
		{ -0.090054181995513 , -0.023733976028684 },
		{ -0.089820820614132 , -0.024488068656596 },
		{ -0.089606648087573 , -0.025142429192915 },
	},
	{ // R2-
		{ -0.092809843463513 , -0.003632869531346 },
		{ -0.092653947154611 , -0.008363102191545 },
		{ -0.092339259493541 , -0.012006160579195 },
		{ -0.091974650024073 , -0.014856707129927 },
		{ -0.091606280057748 , -0.017123461515752 },
		{ -0.091253407935952 , -0.018954380793171 },
	},
	{ // R3+
		{ -0.093411238710366 , -0.022708153387738 },
		{ -0.097233405753192 , -0.027994506104205 },
		{ -0.100597432659066 , -0.033321213330649 },
		{ -0.103557599127117 , -0.038605993532124 },
		{ -0.106159960723347 , -0.043781406950634 },
		{ -0.108444151864595 , -0.048796834889414 },
	},
	{ // R3-
		{ -0.056071497530522 , 0.002044452282529 },
		{ -0.06419780735437 , -0.000404045806309 },
		{ -0.071444079537599 , -0.003684990897704 },
		{ -0.077869702685659 , -0.007644167140195 },
		{ -0.083546675539669 , -0.012129081499869 },
		{ -0.088550493518251 , -0.016998791701339 },
	}

};

const float PROGMEM fi_multisin[WYMIAR_PO_PCA][LICZBA_PROBEK_WIDMA] =
{
	{ -0.07408818069030854,-0.1764970978860203,-0.346684797997707,-0.4903936537154303,-0.4664704436126652,-0.3794247211940266,-0.306543329833602,-0.2542431984454412,-0.21659484535356427,-0.18868993953148755},
	{-0.22336008234532667,-0.5557955369203451,-0.6122370533363055,-0.10419638277036236,0.19073606228499754,0.2497967842948482,0.23512686661499327,0.20734399506778106,0.1813877366414438,0.1598566029132733}
};
//############################################################

//############################################################
//				PARAMETRY SINC'A
const uint16_t PROGMEM czestotliwosci_sinc[LICZBA_PROBEK_WIDMA]={50,60,70,80,90,100,110,120,130,140};
const float  srodek_sinc[WYMIAR_PO_PCA] = { -0.001326798930135853 , -0.000154548196166194 };
const float  graniczna_odleglosc_Mah_sinc = 5.03901320206437e-05;
const float  sigma_sinc[WYMIAR_PO_PCA][WYMIAR_PO_PCA] = { { 1.006881170122792 , 0.1630973695802184} , {0.16309736958021837 , 4.86573089885959} };
const float PROGMEM slownik_uszkodzen_sinc[LICZBA_USZKODZEN][LICZBA_PUNKTOW][WYMIAR_PO_PCA]=
{

	{ // C1+
		{ -0.001346151458525 , -0.000174235689123 },
		{ -0.001375889696531 , -0.000206058506886 },
		{ -0.001400865554832 , -0.000233430849945 },
		{ -0.001421395966054 , -0.000257291326687 },
		{ -0.001438393865816 , -0.000277943201638 },
		{ -0.00145191894711 , -0.000295690868799 },
	},
	{ // C1-
		{ -9.603695335672530e-04 , 8.402831685806414e-05 },
		{ -1.061298767069911e-03 , 4.461476100031354e-05 },
		{ -1.141633739568987e-03 , -8.781728290536002e-07 },
		{ -1.207155443704814e-03 , -4.780552818408866e-05 },
		{ -1.260948535287473e-03 , -9.284108613395183e-05 },
		{ -0.001305241172955 , -0.000133707415163 },
	},
	{ // C2+
		{ -0.00128204900709 , -0.000165938751184 },
		{ -0.00120692078596 , -0.000180753074652 },
		{ -0.001138915079885 , -0.000189781177833 },
		{ -0.001076815120996 , -0.000194917671858 },
		{ -0.00102025732868 , -0.000197325903967 },
		{ -0.000967945999376 , -0.000197124505773 },
	},
	{ // C2-
		{ -0.001920739067135 , 0.000168056633716 },
		{ -1.798811476378746e-03 , 7.561823796878374e-05 },
		{ -1.678921147404567e-03 , -1.383048506137160e-06 },
		{ -1.567699072650670e-03 , -6.220132060835674e-05 },
		{ -0.001466217492015 , -0.000107952185338 },
		{ -0.001373878335879 , -0.000140741733376 },
	},
	{ // R1+
		{ -0.00126328518988 , -0.00015434823416 },
		{ -0.001162309085366 , -0.000152362439763 },
		{ -0.001076199478752 , -0.000148853874858 },
		{ -0.001001827924437 , -0.000144769519084 },
		{ -0.000936708722332 , -0.000140160958078 },
		{ -0.000879631078247 , -0.000135683807001 },
	},
	{ // R1-
		{ -2.630550651371548e-03 , 3.175446658477938e-05 },
		{ -2.240839482141855e-03 , -6.186063269105372e-05 },
		{ -0.001949393574693 , -0.000111132825618 },
		{ -0.001723459303548 , -0.000136448765438 },
		{ -0.001543583079722 , -0.000148933762488 },
		{ -0.001397280402677 , -0.000153930876793 },
	},
	{ // R2+
		{ -0.001326449448242 , -0.0001620656456 },
		{ -0.001325032357307 , -0.000173693181174 },
		{ -0.001323725361757 , -0.000183090266441 },
		{ -0.001322412852867 , -0.00019109576338 },
		{ -0.001320759299365 , -0.000197626950237 },
		{ -0.001319446616039 , -0.000203525709508 },
	},
	{ // R2-
		{ -1.315275325685774e-03 , 1.587723329238969e-05 },
		{ -1.322095289606145e-03 , -3.649777494355048e-05 },
		{ -1.325587629356357e-03 , -7.557032217854054e-05 },
		{ -0.001327063665775 , -0.00010506554959 },
		{ -0.001327481452779 , -0.000128083036932 },
		{ -0.001327416384181 , -0.000146234335173 },
	},
	{ // R3+
		{ -0.001367030609457 , -0.00017913200087 },
		{ -0.001434026221315 , -0.000222223825673 },
		{ -0.00149420827462 , -0.000262700978728 },
		{ -0.001548352461501 , -0.000300612037822 },
		{ -0.001596286045473 , -0.000335531394231 },
		{ -0.00163933272609 , -0.000367049479569 },
	},
	{ // R3-
		{ -7.619757378801964e-04 , 4.081726977404449e-05 },
		{ -8.884453326810457e-04 , 2.172375649213655e-05 },
		{ -1.003696438018219e-03 , -7.252411618617423e-06 },
		{ -1.107288198864747e-03 , -4.411873330479051e-05 },
		{ -1.200063221141614e-03 , -8.591153347419316e-05 },
		{ -0.001283665103268 , -0.000130069550551 },
	}

};

const float PROGMEM fi_sinc[WYMIAR_PO_PCA][LICZBA_PROBEK_WIDMA] =
{
	{ -0.2175328739467297,-0.29132055579491745,-0.355383948091038,-0.3885763178503258,-0.3842807371766349,-0.3567048067751333,-0.3227879517128243,-0.29106466377180684,-0.2634731959271273,-0.2393400254612924},
	{-0.5868185393516206,-0.5170211261577655,-0.2873573271468695,-0.044964189818663125,0.12136617714961956,0.20874982754417304,0.24517821622163882,0.2546275822996633,0.2507202903434472,0.24004724186253643}
};
//############################################################

#endif


//############################################################
//				FUNKCJE
float iloczyn_skalarny(float * wektor1, float * wektor2, uint8_t dlugosc)
{
	float wynik = 0;
	uint8_t i=0;
	for(i=0;i<dlugosc;++i)
	{
		wynik += wektor1[i] * wektor2[i];
	}
	return wynik;
}

float odleglosc_Mahalanobisa(float punkt [],const float mu[], const float sigma[WYMIAR_PO_PCA][WYMIAR_PO_PCA])
{
	uint8_t i = 0;
	float wynik = 0;
	float x[WYMIAR_PO_PCA];
	for (i=0;i<WYMIAR_PO_PCA;++i)
	{
		x[i]=punkt[i]-mu[i];
	}
	wynik = sigma[0][0]*x[0]*x[0]+sigma[1][0]*x[0]*x[1]+sigma[0][1]*x[0]*x[1]+sigma[1][1]*x[1]*x[1]; // mnozenie macierzy
	wynik = sqrt(wynik);
	return wynik;

}

void PCA (float phi[WYMIAR_PO_PCA][LICZBA_PROBEK_WIDMA],float x[],float wynik [])
{
	uint8_t i=0;
	for (i=0; i<WYMIAR_PO_PCA; i++)
	{
		wynik[i] = iloczyn_skalarny( phi[i],x,LICZBA_PROBEK_WIDMA); // mnozenie Ax, to iloczyn skalarny wierszy macierzy A z wektorem x
	}
}

void roznica_wektorow(float * v1, float * v2, float * wynik , uint8_t dlugosc)
{
	uint8_t i;
	for(i=0; i < dlugosc; i++ )
	{
		wynik[i] = v1[i] - v2[i];
	}
}

float funkcja_g(float * x, float * c1, float * c2)
{
	float a[WYMIAR_PO_PCA];
	float r[WYMIAR_PO_PCA];
	roznica_wektorow(c2,c1,a,WYMIAR_PO_PCA);// a =c2 - c1
	roznica_wektorow(x,c1,r,WYMIAR_PO_PCA); // r = x - c1 -> pomocniczy wektor

	return iloczyn_skalarny(a,r,WYMIAR_PO_PCA) / iloczyn_skalarny(a,a,WYMIAR_PO_PCA);
}

float funkcja_h(float g_od_x)
{
	if (g_od_x <= 0.0)  return 0.0;
	if (g_od_x >= 1.0)  return 1.0;
	return g_od_x;
}

float odleglosc_punktu_od_odcinka(float * x, float * c1, float * c2)
{
	float a[WYMIAR_PO_PCA];
	float w[WYMIAR_PO_PCA];
	float x_minus_w[WYMIAR_PO_PCA];
	float g_od_x;

	roznica_wektorow(c2,c1,a,WYMIAR_PO_PCA); // a = c2 - c1
	g_od_x = funkcja_g(x,c1,c2);


	funkcja_w( c1, a, funkcja_h( g_od_x ), w);
	roznica_wektorow(x, w, x_minus_w, WYMIAR_PO_PCA);

	return sqrt( iloczyn_skalarny(x_minus_w, x_minus_w, WYMIAR_PO_PCA) ); // ||x - w(x)||^2
}

void funkcja_w(float * c1, float * a ,float h_od_x, float * wynik)
{
	uint8_t i;

	for(i = 0; i < WYMIAR_PO_PCA; i++)
	{
		wynik[i] = c1[i] + a[i] * h_od_x; // d = c1 + a*h( g(x) )
	}
}

uint8_t klasyfikacja(float * widmo, uint8_t typ_slownika)
{
	uint8_t i,j; // liczniki
	uint8_t etykieta = 0;
	float bufor[LICZBA_PUNKTOW][WYMIAR_PO_PCA];
	float fi[WYMIAR_PO_PCA][LICZBA_PROBEK_WIDMA]; // fi 2x10
	float d_min = 100000;// przyjmujemy poczatkowa duza wartosc
	float d;
	
	float x[WYMIAR_PO_PCA];
	
	if ( SLOWNIK_SINC == typ_slownika )
	{
		memcpy_P( fi, fi_sinc, WYMIAR_PO_PCA * LICZBA_PROBEK_WIDMA * sizeof(float) );
	}
	else
	{
		memcpy_P( fi, fi_multisin, WYMIAR_PO_PCA * LICZBA_PROBEK_WIDMA * sizeof(float) );
	}
	
	PCA(fi, widmo, x);

	for(i=0; i < LICZBA_USZKODZEN; i++) // sprawdzamy kazdy element ukladu
	{
		if ( SLOWNIK_SINC == typ_slownika )
		{
			memcpy_P( bufor, slownik_uszkodzen_sinc[i], LICZBA_PUNKTOW * WYMIAR_PO_PCA * sizeof(float) );
		}
		else
		{
			// domyslnie slownik multisin
			memcpy_P( bufor, slownik_uszkodzen_multisin[i], LICZBA_PUNKTOW * WYMIAR_PO_PCA * sizeof(float) );
		}
		
		for(j = 0; j < LICZBA_PUNKTOW - 1; j++)// sprawdzamy kazdy punkt w slowniku dla danego elementu
		{
			d = odleglosc_punktu_od_odcinka(x,bufor[j],bufor[j+1]);
			if (d < d_min)
			{
				d_min = d;
				etykieta = i;
			}
		}
	}

	return etykieta; // zwracamy numer etykiety uszkodzenia od 0 do 9 (od C1_PLUS do R2_MINUS)
}

uint8_t stan_nominalny(float * widmo,  uint8_t typ_slownika)
{
	//float s = odleglosc_Mahalanobisa(x, srodek_multisin, sigma_multisin);
	float s;
	float graniczna_odleglosc_Mah;
	float fi[WYMIAR_PO_PCA][LICZBA_PROBEK_WIDMA]; // fi 2x10
	float x[WYMIAR_PO_PCA];
	
	if ( SLOWNIK_SINC == typ_slownika )
	{
		memcpy_P( fi, fi_sinc, WYMIAR_PO_PCA * LICZBA_PROBEK_WIDMA * sizeof(float) );
		PCA(fi, widmo, x);
		s = odleglosc_Mahalanobisa(x, srodek_sinc, sigma_sinc);
		graniczna_odleglosc_Mah = graniczna_odleglosc_Mah_sinc;
	}
	else
	{
		// domyslnie slownik multisin
		memcpy_P( fi, fi_multisin, WYMIAR_PO_PCA * LICZBA_PROBEK_WIDMA * sizeof(float) );
		PCA(fi, widmo, x);
		s = odleglosc_Mahalanobisa(x, srodek_multisin, sigma_multisin);
		graniczna_odleglosc_Mah = graniczna_odleglosc_Mah_multisin;
	}

	if (s > graniczna_odleglosc_Mah)
	{
		return 0; // uklad nie jest w stanie nominalnym -> USZKODZENIE!
	}
	else
	{
		return 1; // uklad sprawny -> STAN NOMINALNY
	}
}

//############################################################